# Sprint 25.1: Browse Endpoint Redesign

## Goal
Redesign the `/browse` endpoint to standardize browser interaction, keep Camoufox as the default executor, extend Chromium support, and improve overall stability and maintainability.

## Background
The existing `/browse` endpoint has evolved organically, leading to inconsistencies in browser handling and ad-hoc switches between Chromium and Camoufox. This has introduced complexity, made maintenance challenging, and blocked a clean experience when Chromium is required.

## Problem Statement
The current `/browse` endpoint is not standardized, making it difficult to manage and extend. Chromium support exists only through bespoke code paths, complicating testing and deployment.

## Objectives
1.  **Standardize Browser Interaction**: Provide a unified execution pathway for the `/browse` endpoint while allowing both Camoufox (default) and Chromium engines.
2.  **Surface Explicit Selection**: Replace implicit toggles with request-driven engine selection that defaults to Camoufox but cleanly enables Chromium.
3.  **Improve Maintainability**: Simplify the codebase by centralizing browser choice logic in the service layer.
4.  **Enhance Stability**: Reduce potential points of failure by consolidating browser execution logic and tightening engine-specific error handling.

## Functional Requirements
-   The `/browse` endpoint MUST support both Camoufox (default) and Chromium engines selected via the request payload.
-   Existing functionalities of the `/browse` endpoint (e.g., page navigation, content extraction) MUST be preserved for both engines.
-   Error handling for browser operations MUST be robust and consistent.

## Non-Functional Requirements
- Preserve layered architecture; no business logic inside routers.
- Python 3.10.8 compatible, fully type hinted, `flake8` clean.
- No `.venv`; rely on system Python per constitution.
- Files remain under 140 columns to appease `black`/`flake8`.

## API Contract (Draft)

### Request
```json
{
  "start_url": "https://example.com",
  "engine": "chromium"
}
```

### Response
```json
{
  "status": "success",
  "message": "Browser session completed successfully"
}
```

## High-Level Design

### Core Changes
-   **Service Layer**: Refactor `app/services/browser/browse.py` and associated modules to provide a single entry point that dispatches to Camoufox or Chromium executors based on the request.
-   **Configuration**: Normalize engine selection logic around request payloads and shared configuration defaults.
-   **API Endpoint**: Update `app/api/browse.py` to validate the requested engine and bubble it to the service layer.

### Data Flow (Simplified)
1.  Client calls `/browse` endpoint with `BrowseRequest` schema.
2.  `app/api/browse.py` dispatches to `app/services/browser/browse.py`.
3.  `app/services/browser/browse.py` initializes the appropriate executor (`CamoufoxBrowser` or Chromium-backed executor).
4.  Browser performs actions (e.g., `goto`, `screenshot`, `evaluate`) using the selected engine.
5.  Results are returned to the client.

## Migration Plan
> **⚠️ BACKWARDS INCOMPATIBILITY NOTICE**: This change introduces backwards incompatibility and requires consumers to update their implementations accordingly.

1.  **Identify affected code**: Pinpoint all ad-hoc Chromium or Camoufox switches tied to the `/browse` endpoint.
2.  **Refactor services**: Modify `app/services/browser/browse.py` and its dependencies to expose a unified interface with engine selection.
3.  **Update API**: Adjust `app/api/browse.py` to accept and validate an `engine` parameter while defaulting to Camoufox.
4.  **Testing**: Thoroughly test the `/browse` endpoint to ensure all functionalities work as expected for Camoufox and Chromium.
5.  **Deployment**: Roll out the changes.

## Risks & Mitigations
-   **Risk**: Unforeseen issues with Camoufox or Chromium compatibility for existing browse functionalities.
    -   **Mitigation**: Extensive testing, including integration tests, to ensure feature parity.
-   **Risk**: Breaking changes for consumers relying on specific Chromium behaviors or Camoufox-only flows.
    -   **Mitigation**: Clear communication of changes, explicit engine selection in requests, and deprecation notices if necessary.

## Testing Strategy
-   **Unit Tests**: Update existing unit tests for browser services to cover shared logic and engine-specific behaviors.
-   **Integration Tests**: Develop new integration tests specifically for the `/browse` endpoint to verify end-to-end functionality for both Camoufox and Chromium.
-   **Manual Testing**: Perform manual checks on critical browsing scenarios for each engine.

## Dependencies
-   Camoufox library
-   Pydantic for request/response schemas
-   Chromium automation stack (Scrapling/Camoufox Chromium-compatible executor)

## Acceptance Criteria
-   The `/browse` endpoint successfully executes all defined browsing actions using the selected engine.
-   All existing tests pass, and new integration tests for the `/browse` endpoint pass for both engines.
-   The codebase for `/browse` is simpler and easier to understand.

