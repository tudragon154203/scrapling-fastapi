name: 'ğŸ¤– Main (Dispatcher)'

on:
  pull_request:
    types:
      - opened
      - synchronize
      - ready_for_review
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  determine:
    runs-on: ${{ vars.OS || 'ubuntu-latest' }}
    outputs:
      run_aider: ${{ steps.filter.outputs.run_aider }}
      run_claude: ${{ steps.filter.outputs.run_claude }}
      run_gemini: ${{ steps.filter.outputs.run_gemini }}
      run_opencode: ${{ steps.filter.outputs.run_opencode }}
      target_id: ${{ steps.filter.outputs.target_id }}
      target_type: ${{ steps.filter.outputs.target_type }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: filter
        env:
          ACTIVE_BOTS_VAR: ${{ vars.ACTIVE_BOTS }}
          ACTIVE_BOTS_ENV: ${{ env.ACTIVE_BOTS }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_PAYLOAD: ${{ toJson(github.event) }}
        run: python .github/workflows/scripts/dispatcher_filter.py

  aider:
    needs: determine
    if: needs.determine.outputs.run_aider == 'true'
    uses: ./.github/workflows/aider.yml
    secrets: inherit
    with:
      event-name: ${{ github.event_name }}
      event: ${{ toJson(github.event) }}
      target-id: ${{ needs.determine.outputs.target_id }}
      target-type: ${{ needs.determine.outputs.target_type }}

  claude:
    needs: determine
    if: needs.determine.outputs.run_claude == 'true'
    uses: ./.github/workflows/claude.yml
    secrets: inherit
    with:
      event-name: ${{ github.event_name }}
      event: ${{ toJson(github.event) }}
      target-id: ${{ needs.determine.outputs.target_id }}
      target-type: ${{ needs.determine.outputs.target_type }}

  gemini:
    needs: determine
    if: needs.determine.outputs.run_gemini == 'true'
    uses: ./.github/workflows/gemini.yml
    secrets: inherit
    with:
      event-name: ${{ github.event_name }}
      event: ${{ toJson(github.event) }}
      target-id: ${{ needs.determine.outputs.target_id }}
      target-type: ${{ needs.determine.outputs.target_type }}

  opencode:
    needs: determine
    if: needs.determine.outputs.run_opencode == 'true'
    uses: ./.github/workflows/opencode.yml
    secrets: inherit
    with:
      event-name: ${{ github.event_name }}
      event: ${{ toJson(github.event) }}
      target-id: ${{ needs.determine.outputs.target_id }}
      target-type: ${{ needs.determine.outputs.target_type }}
