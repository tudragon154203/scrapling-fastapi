Refactor before writing tests and make sure tests are run after written