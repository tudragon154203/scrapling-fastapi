openapi: 3.0.0
info:
  title: TikTok Session API
  version: 1.0.0
  description: |
    TikTok session endpoint providing interactive browsing capabilities with login status checking.
    
    ## Authentication
    This endpoint uses existing authentication mechanisms defined in the application.
    
    ## Features
    - Interactive browser session for TikTok
    - Automatic login status detection
    - Read-only user data management
    - Session timeout handling
    - Comprehensive error responses

servers:
  - url: http://localhost:5681
    description: Development server

paths:
  /tiktok/session:
    post:
      tags:
        - TikTok Session
      summary: Create TikTok interactive session
      description: |
        Creates an interactive browser session for TikTok with automatic login status checking.
        
        The endpoint operates similarly to the existing `/browse` endpoint but with TikTok-specific considerations:
        - Launches browser with TikTok-specific configuration
        - Checks TikTok login status using multiple detection methods
        - Returns 409 if user is not logged in
        - Provides full interactive capabilities when logged in
        - Uses read-only user data directory cloning
        
        ## Login Detection Process
        1. Navigate to TikTok home page
        2. Wait for login-specific DOM elements or API requests
        3. Use fallback methods if inconclusive
        4. Return appropriate response based on detection result
        
        ## User Data Management
        - Clone master user data directory to read-only session directory
        - Clean up session directory on browser close or timeout
        - Support write mode (disabled by default) with locking
        
        ## Session Behavior
        - Full interactive capabilities while session is active
        - Session ends on browser close or timeout (default 5 minutes)
        - Proxy values redacted in logs for security
      operationId: createTikTokSession
      security:
        - cookieAuth: []
        - apiKeyAuth: []
      
      requestBody:
        description: Empty request body - all configuration derived from context
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              example: {}
      
      responses:
        '200':
          description: Session created successfully - user is logged in to TikTok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionSuccess'
          headers:
            X-Session-Id:
              description: Unique session identifier
              schema:
                type: string
                example: "550e8400-e29b-41d4-a716-446655440000"
            
        '409':
          description: User is not logged in to TikTok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionError'
          headers:
            X-Error-Code:
              description: Error classification
              schema:
                type: string
                example: "NOT_LOGGED_IN"
                
        '423':
          description: User data directory is locked (write mode only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionError'
          headers:
            X-Error-Code:
              description: Error classification
              schema:
                type: string
                example: "USER_DATA_LOCKED"
                
        '504':
          description: Session timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionError'
          headers:
            X-Error-Code:
              description: Error classification
              schema:
                type: string
                example: "SESSION_TIMEOUT"
                
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionError'
          headers:
            X-Error-Code:
              description: Error classification
              schema:
                type: string
                example: "INTERNAL_ERROR"
                
        '400':
          description: Bad request - invalid request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TikTokSessionError'
          headers:
            X-Error-Code:
              description: Error classification
              schema:
                type: string
                example: "INVALID_REQUEST"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session_token
      description: Session-based authentication via cookie
    
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication

  schemas:
    TikTokSessionSuccess:
      type: object
      properties:
        status:
          type: string
          enum: ["success"]
          description: Response status indicator
        message:
          type: string
          description: Success message
          example: "TikTok session established successfully"
        session_id:
          type: string
          description: Unique session identifier (should be in header X-Session-Id)
          example: "550e8400-e29b-41d4-a716-446655440000"
      required:
        - status
        - message
      additionalProperties: false

    TikTokSessionError:
      type: object
      properties:
        status:
          type: string
          enum: ["error"]
          description: Response status indicator
        message:
          type: string
          description: Error message
        error_details:
          type: object
          description: Additional error information
          properties:
            code:
              type: string
              description: Error classification code
            details:
              type: string
              description: Detailed error information
            method:
              type: string
              description: Method that failed (if applicable)
            timeout:
              type: integer
              description: Timeout value in seconds (if applicable)
            retry_count:
              type: integer
              description: Number of retries attempted (if applicable)
      required:
        - status
        - message
      additionalProperties: false
      
      examples:
        not_logged_in:
          summary: User not logged in
          value:
            status: "error"
            message: "Not logged in to TikTok"
            error_details:
              code: "NOT_LOGGED_IN"
              details: "User is not logged in to TikTok"
              method: "dom_api_combo"
        
        session_timeout:
          summary: Session timed out
          value:
            status: "error"
            message: "Session timed out"
            error_details:
              code: "SESSION_TIMEOUT"
              details: "Session exceeded maximum duration"
              timeout: 300
        
        user_data_locked:
          summary: User data directory locked
          value:
            status: "error"
            message: "User data directory is locked"
            error_details:
              code: "USER_DATA_LOCKED"
              details: "Cannot acquire lock on user data directory"
        
        internal_error:
          summary: Internal server error
          value:
            status: "error"
            message: "Internal server error"
            error_details:
              code: "INTERNAL_ERROR"
              details: "An unexpected error occurred"

    TikTokLoginState:
      type: string
      enum: [logged_in, logged_out, uncertain]
      description: Internal state representing TikTok login detection result
      hidden: true

    TikTokSessionConfig:
      type: object
      description: Internal configuration for TikTok session execution
      properties:
        login_detection_timeout:
          type: integer
          default: 8
          description: Login detection timeout in seconds
        
        write_mode_enabled:
          type: boolean
          default: false
          description: Enable write mode for user data directory
        
        max_session_duration:
          type: integer
          default: 300
          description: Maximum session duration in seconds
        
        tiktok_url:
          type: string
          default: "https://www.tiktok.com/"
          description: TikTok base URL
      
      hidden: true

tags:
  - name: TikTok Session
    description: TikTok interactive session management